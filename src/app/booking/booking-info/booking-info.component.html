<div class="container mt-4 mb-5">
  <!-- Back Button -->
  <div class="row mb-3">
    <div class="col-12">
      <button class="btn btn-outline-secondary" (click)="goBack()">
        <i class="bi bi-arrow-left me-2"></i>Back to Bookings
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading booking details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ error }}
    <button class="btn btn-sm btn-outline-danger ms-3" (click)="loadBookingDetail()">
      <i class="bi bi-arrow-clockwise me-1"></i>Retry
    </button>
  </div>

  <!-- Save Error Alert -->
  <div *ngIf="saveError" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ saveError }}
    <button type="button" class="btn-close" (click)="saveError = null"></button>
  </div>

  <!-- Booking Details -->
  <div *ngIf="booking && !loading" class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
      <!-- Passenger Information Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-person-circle me-2"></i>Passenger Information
          </h5>
          <span class="badge" [ngClass]="getStatusBadgeClass(editMode ? editedBooking.status : booking.status)">
            {{ editMode ? editedBooking.status : booking.status }}
          </span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="d-flex align-items-center mb-4">
                <div class="avatar-circle bg-primary text-white me-3">
                  {{ editMode ? editedBooking.firstName.charAt(0) : booking.firstName.charAt(0) }}{{ editMode ?
                  editedBooking.lastName.charAt(0) : booking.lastName.charAt(0) }}
                </div>
                <div>
                  <h4 class="mb-0">
                    {{ editMode ? editedBooking.firstName : booking.firstName }}
                    {{ editMode ? editedBooking.lastName : booking.lastName }}
                  </h4>
                  <span *ngIf="(editMode ? editedBooking.leadPassenger : booking.leadPassenger === 'true')"
                    class="badge bg-warning text-dark">
                    <i class="bi bi-star-fill me-1"></i>Lead Passenger
                  </span>
                </div>
              </div>
            </div>
            <div class="col-md-6 text-md-end">
              <!-- Edit Mode Buttons -->
              <ng-container *ngIf="editMode">
                <button class="btn btn-success me-2" (click)="saveBooking()" [disabled]="saving">
                  <span *ngIf="!saving">
                    <i class="bi bi-check-lg me-1"></i>Save Changes
                  </span>
                  <span *ngIf="saving">
                    <span class="spinner-border spinner-border-sm me-1"></span>Saving...
                  </span>
                </button>
                <button class="btn btn-outline-secondary" (click)="cancelEdit()" [disabled]="saving">
                  <i class="bi bi-x-lg me-1"></i>Cancel
                </button>
              </ng-container>
              <!-- View Mode Buttons -->
              <ng-container *ngIf="!editMode">
                <button class="btn btn-primary me-2" (click)="editBooking()">
                  <i class="bi bi-pencil me-1"></i>Edit Booking
                </button>
                <button class="btn btn-outline-primary" (click)="printBooking()">
                  <i class="bi bi-printer me-1"></i>Print
                </button>
              </ng-container>
            </div>
          </div>

          <hr>

          <!-- View Mode -->
          <ng-container *ngIf="!editMode">
            <div class="row">
              <div class="col-md-6">
                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">First Name</label>
                  <div class="fw-bold">{{ booking.firstName }}</div>
                </div>

                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">Last Name</label>
                  <div class="fw-bold">{{ booking.lastName }}</div>
                </div>

                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">Gender</label>
                  <div class="fw-bold">
                    <i class="bi bi-gender-{{ booking.gender.toLowerCase() }} me-2"></i>
                    {{ booking.gender }}
                  </div>
                </div>

                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">Date of Birth</label>
                  <div class="fw-bold">
                    <i class="bi bi-cake me-2"></i>
                    {{ formatDate(booking.dob) }}
                    <span class="text-muted small">({{ calculateAge(booking.dob) }} years old)</span>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">Citizenship</label>
                  <div class="fw-bold">
                    <i class="bi bi-flag me-2"></i>
                    {{ booking.citizenship }}
                  </div>
                </div>

                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">Place of Birth</label>
                  <div class="fw-bold">
                    <i class="bi bi-geo-alt me-2"></i>
                    {{ booking.placeOfBirth }}
                  </div>
                </div>

                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">Participant Type</label>
                  <div>
                    <span class="badge bg-info">{{ booking.participantType }}</span>
                  </div>
                </div>

                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">Booking ID</label>
                  <div class="font-monospace small text-muted">{{ booking.referenceNumber }}</div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- Edit Mode -->
          <ng-container *ngIf="editMode">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">First Name</label>
                  <input type="text" class="form-control" [(ngModel)]="editedBooking.firstName" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">Last Name</label>
                  <input type="text" class="form-control" [(ngModel)]="editedBooking.lastName" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">Gender</label>
                  <select class="form-select" [(ngModel)]="editedBooking.gender" required>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Date of Birth</label>
                  <input type="date" class="form-control" [(ngModel)]="editedBooking.dob" required>
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Citizenship</label>
                  <input type="text" class="form-control" [(ngModel)]="editedBooking.citizenship" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">Place of Birth</label>
                  <input type="text" class="form-control" [(ngModel)]="editedBooking.placeOfBirth" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">Participant Type</label>
                  <input type="text" class="form-control" [(ngModel)]="editedBooking.participantType" required>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Passport Information Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-passport me-2"></i>Passport Information
          </h5>
        </div>
        <div class="card-body">
          <div *ngIf="isPassportExpiringSoon(editMode ? editedBooking.expiryDate : booking.expiryDate)"
            class="alert alert-warning mb-3">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> Passport expires within 6 months!
          </div>

          <!-- View Mode -->
          <ng-container *ngIf="!editMode">
            <div class="row">
              <div class="col-md-6">
                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">Passport Number</label>
                  <div class="fw-bold font-monospace">{{ booking.passportNumber }}</div>
                </div>

                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">Issue Date</label>
                  <div class="fw-bold">
                    <i class="bi bi-calendar-check me-2"></i>
                    {{ formatDate(booking.issueDate) }}
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="info-item mb-3">
                  <label class="text-muted small mb-1">Expiry Date</label>
                  <div class="fw-bold" [class.text-danger]="isPassportExpiringSoon(booking.expiryDate)">
                    <i class="bi bi-calendar-x me-2"></i>
                    {{ formatDate(booking.expiryDate) }}
                    <i *ngIf="isPassportExpiringSoon(booking.expiryDate)"
                      class="bi bi-exclamation-circle text-danger ms-2"></i>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- Edit Mode -->
          <ng-container *ngIf="editMode">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Passport Number</label>
                  <input type="text" class="form-control" [(ngModel)]="editedBooking.passportNumber" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">Issue Date</label>
                  <input type="date" class="form-control" [(ngModel)]="editedBooking.issueDate" required>
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Expiry Date</label>
                  <input type="date" class="form-control" [(ngModel)]="editedBooking.expiryDate" required>
                  <small *ngIf="isPassportExpiringSoon(editedBooking.expiryDate)" class="text-danger">
                    <i class="bi bi-exclamation-circle me-1"></i>Expires within 6 months
                  </small>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Additional Participants Card -->
      <div class="card shadow-sm mb-4" *ngIf="booking.participants && booking.participants.length > 0">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-people me-2"></i>Additional Participants ({{ booking.participants.length }})
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <div *ngFor="let participant of booking.participants; let i = index" class="list-group-item p-0">
              <!-- Participant Header (Clickable) -->
              <div (click)="toggleParticipant(participant.id)"
                class="p-3 d-flex justify-content-between align-items-center"
                style="cursor: pointer; background-color: #f8f9fa;"
                [class.border-bottom]="i < booking.participants.length - 1">
                <div class="d-flex align-items-center flex-grow-1">
                  <div class="avatar-circle-sm bg-info text-white me-3">
                    {{ participant.firstName.charAt(0) }}{{ participant.lastName.charAt(0) }}
                  </div>
                  <div>
                    <h6 class="mb-1 fw-bold">{{ participant.firstName }} {{ participant.lastName }}</h6>
                    <small class="text-muted">
                      <i class="bi bi-person me-1"></i>{{ participant.gender }} â€¢
                      <i class="bi bi-calendar me-1"></i>{{ formatDate(participant.dob) }}
                    </small>
                  </div>
                </div>
                <i class="bi" [class.bi-chevron-down]="expandedParticipant !== participant.id"
                  [class.bi-chevron-up]="expandedParticipant === participant.id"
                  style="font-size: 1.5rem; color: #666;"></i>
              </div>

              <!-- Expanded Participant Details -->
              <div *ngIf="expandedParticipant === participant.id" class="p-3 bg-white border-top">
                <div class="row mb-3">
                  <!-- Contact Information -->
                  <div class="col-md-6">
                    <h6 class="text-primary mb-3 fw-bold">
                      <i class="bi bi-telephone me-2"></i>Contact Information
                    </h6>
                    <div class="info-item-sm mb-3">
                      <label class="text-muted small d-block mb-1">Email</label>
                      <div class="small">
                        <a href="mailto:{{ participant.email }}" class="text-decoration-none">
                          {{ participant.email }}
                        </a>
                      </div>
                    </div>
                    <div class="info-item-sm">
                      <label class="text-muted small d-block mb-1">Phone Number</label>
                      <div class="small">
                        <a href="tel:{{ participant.phoneNumber }}" class="text-decoration-none">
                          {{ participant.phoneNumber }}
                        </a>
                      </div>
                    </div>
                  </div>

                  <!-- Personal Information -->
                  <div class="col-md-6">
                    <h6 class="text-primary mb-3 fw-bold">
                      <i class="bi bi-person-vcard me-2"></i>Personal Details
                    </h6>
                    <div class="info-item-sm mb-3">
                      <label class="text-muted small d-block mb-1">Citizenship</label>
                      <div class="small fw-bold">{{ participant.citizenship }}</div>
                    </div>
                    <div class="info-item-sm">
                      <label class="text-muted small d-block mb-1">Place of Birth</label>
                      <div class="small">{{ participant.placeOfBirth }}</div>
                    </div>
                  </div>
                </div>

                <hr class="my-3">

                <!-- Passport Information -->
                <h6 class="text-primary mb-3 fw-bold">
                  <i class="bi bi-passport me-2"></i>Passport Information
                </h6>
                <div class="row">
                  <div class="col-md-6">
                    <div class="info-item-sm mb-3">
                      <label class="text-muted small d-block mb-1">Passport Number</label>
                      <div class="small font-monospace fw-bold">{{ participant.passportNumber }}</div>
                    </div>
                    <div class="info-item-sm">
                      <label class="text-muted small d-block mb-1">Issue Date</label>
                      <div class="small">{{ formatDate(participant.issueDate) }}</div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="info-item-sm mb-3">
                      <label class="text-muted small d-block mb-1">Expiry Date</label>
                      <div class="small fw-bold" [class.text-danger]="isPassportExpiringSoon(participant.expiryDate)">
                        {{ formatDate(participant.expiryDate) }}
                        <i *ngIf="isPassportExpiringSoon(participant.expiryDate)"
                          class="bi bi-exclamation-circle text-danger ms-2"></i>
                      </div>
                    </div>
                    <div class="info-item-sm">
                      <label class="text-muted small d-block mb-1">Added On</label>
                      <div class="small text-muted">{{ formatDate(participant.createdAt) }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tour Information Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-airplane me-2"></i>Tour Details
          </h5>
        </div>
        <div class="card-body">
          <div class="tour-header mb-3">
            <h4 class="text-primary mb-2">{{ booking.tour.tourName }}</h4>
            <p class="text-muted">{{ booking.tour.tourDescription }}</p>
          </div>

          <hr>

          <div class="row">
            <div class="col-md-6">
              <div class="info-item mb-3">
                <label class="text-muted small mb-1">Departure Date</label>
                <div class="fw-bold">
                  <i class="bi bi-calendar-event me-2 text-success"></i>
                  {{ formatDate(booking.tour.departureDate) }}
                </div>
              </div>

              <div class="info-item mb-3">
                <label class="text-muted small mb-1">Arrival Date</label>
                <div class="fw-bold">
                  <i class="bi bi-calendar-event me-2 text-danger"></i>
                  {{ formatDate(booking.tour.arrivalDate) }}
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="info-item mb-3">
                <label class="text-muted small mb-1">Duration</label>
                <div class="fw-bold">
                  <i class="bi bi-moon-stars me-2"></i>
                  {{ booking.tour.noOfNights }} Nights
                </div>
              </div>

              <div class="info-item mb-3">
                <label class="text-muted small mb-1">Tour Status</label>
                <div>
                  <span class="badge bg-secondary">{{ booking.tour.status }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="info-item mb-3">
            <label class="text-muted small mb-1">Tour ID</label>
            <div class="font-monospace small text-muted">{{ booking.tour.id }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Price Summary Card -->
      <div class="card shadow-sm mb-4 border-primary">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-cash-coin me-2"></i>Price Summary
          </h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Price per Person</span>
            <h4 class="text-success mb-0">${{ booking.tour.price }}</h4>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-2">
            <span class="small">Base Price (per person)</span>
            <span class="small">${{ booking.tour.price }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="small">Number of Participants</span>
            <span class="small">{{ getTotalParticipants() }}</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <strong>Total Amount</strong>
            <h5 class="text-primary mb-0">${{ calculateTotalPrice() }}</h5>
          </div>
        </div>
      </div>

      <!-- Status Management Card -->
      <div class="card shadow-sm mb-4 border-primary">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0">
            <i class="bi bi-gear me-2"></i>Booking Status
          </h6>
        </div>
        <div class="card-body">
          <!-- Current Status Display -->
          <div class="mb-3">
            <label class="text-muted small d-block mb-2">Current Status</label>
            <span class="badge fs-6" [ngClass]="getStatusBadgeClass(booking.status)">
              {{ booking.status }}
            </span>
          </div>

          <hr>

          <!-- Status Update Section -->
          <div *ngIf="booking.status.toString() === 'CLOSED'">
            <div class="alert alert-secondary py-2 small mb-0">
              <i class="bi bi-lock me-2"></i>This booking is closed and cannot be modified
            </div>
          </div>

          <div *ngIf="booking.status.toString() !== 'CLOSED'">
            <label class="form-label small text-muted">Change Status</label>
            <select class="form-select" [(ngModel)]="selectedStatus" (change)="onStatusChange($event)"
              [disabled]="saving || editMode">
              <option value="">-- Select New Status --</option>
              <option *ngFor="let status of getAvailableStatuses()" [value]="status">
                {{ status }}
              </option>
            </select>
            <small class="text-muted d-block mt-2">
              <i class="bi bi-info-circle me-1"></i>
              Select a status to update the booking
            </small>
          </div>
        </div>
      </div>

      <!-- Quick Actions Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h6 class="mb-0">Quick Actions</h6>
        </div>
        <div class="list-group list-group-flush">
          <button class="list-group-item list-group-item-action" [disabled]="editMode || saving">
            <i class="bi bi-envelope me-2"></i>Send Confirmation Email
          </button>
          <button class="list-group-item list-group-item-action" [disabled]="editMode || saving">
            <i class="bi bi-download me-2"></i>Download Itinerary
          </button>
          <button class="list-group-item list-group-item-action" [disabled]="editMode || saving">
            <i class="bi bi-credit-card me-2"></i>Payment History
          </button>
          <button class="list-group-item list-group-item-action text-danger"
            [disabled]="editMode || saving || booking.status.toString()=== 'CLOSED'"
            (click)="selectedStatus = 'REJECTED'; updateBookingStatus('REJECTED')">
            <i class="bi bi-x-circle me-2"></i>Cancel Booking
          </button>
        </div>
      </div>

      <!-- Contact Information Card -->
      <div class="card shadow-sm">
        <div class="card-header">
          <h6 class="mb-0">Need Help?</h6>
        </div>
        <div class="card-body">
          <p class="small text-muted mb-2">
            For any questions or changes to your booking, please contact us:
          </p>
          <div class="mb-2">
            <i class="bi bi-telephone me-2"></i>
            <a href="tel:+1234567890">+1 (234) 567-890</a>
          </div>
          <div>
            <i class="bi bi-envelope me-2"></i>
            <a href="mailto:lionssportsclub2000@gmail.com">support&#64;tours.com</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>